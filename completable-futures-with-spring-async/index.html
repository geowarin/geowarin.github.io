<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Completable futures with Spring async | Geowarin</title><meta name=keywords content="spring,futures,async,featured"><meta name=description content="Use Java 8 new CompletableFuture with Spring async"><meta name=author content="Geoffroy Warin"><link rel=canonical href=https://geowarin.com/completable-futures-with-spring-async/><link crossorigin=anonymous href=/assets/css/stylesheet.9833c27727234979007d10a429f9b9c344f4f4afb85485b21ebd2892f3b4c439.css integrity="sha256-mDPCdycjSXkAfRCkKfm5w0T09K+4VIWyHr0okvO0xDk=" rel="preload stylesheet" as=style><link rel=icon href=https://geowarin.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://geowarin.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://geowarin.com/favicon-32x32.png><link rel=apple-touch-icon href=https://geowarin.com/apple-touch-icon.png><link rel=mask-icon href=https://geowarin.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://geowarin.com/completable-futures-with-spring-async/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://geowarin.com/completable-futures-with-spring-async/"><meta property="og:site_name" content="Geowarin"><meta property="og:title" content="Completable futures with Spring async"><meta property="og:description" content="Use Java 8 new CompletableFuture with Spring async"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2015-06-12T00:00:00+00:00"><meta property="article:modified_time" content="2015-06-12T00:00:00+00:00"><meta property="article:tag" content="Spring"><meta property="article:tag" content="Futures"><meta property="article:tag" content="Async"><meta property="article:tag" content="Featured"><meta name=twitter:card content="summary"><meta name=twitter:title content="Completable futures with Spring async"><meta name=twitter:description content="Use Java 8 new CompletableFuture with Spring async"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://geowarin.com/post/"},{"@type":"ListItem","position":2,"name":"Completable futures with Spring async","item":"https://geowarin.com/completable-futures-with-spring-async/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Completable futures with Spring async","name":"Completable futures with Spring async","description":"Use Java 8 new CompletableFuture with Spring async","keywords":["spring","futures","async","featured"],"articleBody":"Since version 8, java has a way better abstraction than java.util.Future called CompletableFuture. This new API along with the lambdas enables new ways of reasoning with futures by composing, listening and joining them.\nFutures are traditionally created by submitting tasks to an Executor. Spring allows declaring one or multiple executors and will submit any method annotated with @Async as tasks for those executors.\nThe big problem is that executors still return Futures and not CompletableFutures.\nWe are going to create our own Executor to solve this problem. Then we will study a solution to handle timeouts with those futures and as a bonus, do a little bit of AOP to debug our threads.\nYou can see the resulting application on my gihtub.\nCreating an Executor for CompletableFutures If you try to return a CompletableFuture from an Async method in Spring, you will get the following error:\nCaused by: java.lang.ClassCastException: java.util.concurrent.FutureTask cannot be cast to java.util.concurrent.CompletableFuture The idea is to use delegation to decorate an existing instance of ExecutorService. We will implement the ExecutorService and use type covariance to return CompletableFutures instead of Future.\nThe following code has been greatly inspired by this blog post. Many thanks to Brian Oxley!\nSo the first thing we need to do is to create a decorator for an executor service and delegate every method to that service:\nstatic class DelegatingExecutorService implements ExecutorService { protected ExecutorService delegate; public DelegatingExecutorService(ExecutorService executorService) { this.delegate = executorService; } @Override public \u003cT\u003e Future\u003cT\u003e submit(Callable\u003cT\u003e task) { return delegate.submit(task); } @Override public \u003cT\u003e Future\u003cT\u003e submit(Runnable task, T result) { return delegate.submit(task, result); } // Override and delegate everything } We can create an interface that will extends ExecutorService and return CompletableFutures instead of Futures:\n/** * DelegatingCompletableExecutorService {@code ExecutorService} to covariantly return {@code * CompletableFuture} in place of {@code Future}. */ public interface CompletableExecutorService extends ExecutorService { /** * @return a completable future representing pending completion of the * task, never missing */ @Override \u003cT\u003e CompletableFuture\u003cT\u003e submit(Callable\u003cT\u003e task); /** * @return a completable future representing pending completion of the * task, never missing */ @Override \u003cT\u003e CompletableFuture\u003cT\u003e submit(Runnable task, T result); /** * @return a completable future representing pending completion of the * task, never missing */ @Override CompletableFuture\u003c?\u003e submit(Runnable task); } We can then implement this new interface using our decorator as a base:\nstatic class DelegatingCompletableExecutorService extends DelegatingExecutorService implements CompletableExecutorService { DelegatingCompletableExecutorService(ExecutorService threads) { super(threads); } @Override public \u003cT\u003e CompletableFuture\u003cT\u003e submit(Callable\u003cT\u003e task) { final CompletableFuture\u003cT\u003e cf = new CompletableFuture\u003c\u003e(); delegate.submit(() -\u003e { try { cf.complete(task.call()); } catch (CancellationException e) { cf.cancel(true); } catch (Exception e) { cf.completeExceptionally(e); } }); return cf; } @Override public \u003cT\u003e CompletableFuture\u003cT\u003e submit(Runnable task, T result) { return submit(callable(task, result)); } @Override public CompletableFuture\u003c?\u003e submit(Runnable task) { return submit(callable(task)); } } We also need to create an utility method to create a CompletableExecutorService:\npublic static CompletableExecutorService completable(ExecutorService delegate) { return new DelegatingCompletableExecutorService(delegate); } See this gist for the final result.\nCreating an async service To enable asynchronous methods in Spring, you will need this kind of configuration class:\n@Configuration @EnableAsync public class SpringAsyncConfig implements AsyncConfigurer { protected final Log logger = LogFactory.getLog(getClass()); @Override public Executor getAsyncExecutor() { ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(\"async-%d\").build(); return CompletableExecutors.completable(Executors.newFixedThreadPool(10, threadFactory)); } @Override public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() { return (ex, method, params) -\u003e logger.error(\"Uncaught async error\", ex); } } As you can see, we can specify which executor will handle our @Async methods.\nWe can now return CompletableFutures from our services!\n@Service public class AsyncService { private static String[] greetings = new String[]{ \"hallo\", \"hallo\", \"hej\", \"hej\", \"bonjour\", \"hola\", \"ciao\", \"shalom\", \"fáilte\", \"kaixo\", \"konnichiwa\", \"saluton\", \"päivää\", \"selamat pagi\", \"gut de\", \"olá\" }; @Async public CompletableFuture\u003cString\u003e asyncGreeting() { AsyncUtil.randomSleep(3000, TimeUnit.MILLISECONDS); String result = AsyncUtil.getThreadName() + \" - \" + random(greetings); return CompletableFuture.completedFuture(result); } @SafeVarargs public final \u003cT\u003e T random(T... elements) { LinkedList\u003cT\u003e greetings = new LinkedList\u003c\u003e(Arrays.asList(elements)); Collections.shuffle(greetings, ThreadLocalRandom.current()); return greetings.getFirst(); } } Here is the AsyncUtil class in case you are wondering what’s going on:\npublic class AsyncUtil { public static void randomSleep(int duration, TimeUnit timeUnit) { try { timeUnit.sleep(ThreadLocalRandom.current().nextInt(duration)); } catch (InterruptedException e) { Throwables.propagate(e); } } public static String getThreadName() { return Thread.currentThread().getName(); } } Our service will say hello in a random language within 3 seconds of time. How do we handle the result?\npublic class Runner implements CommandLineRunner { @Autowired private AsyncService asyncService; @Override public void run(String... args) throws Exception { IntStream.rangeClosed(1, 10) .mapToObj(__ -\u003e asyncService.asyncGreeting().exceptionally(Throwable::getMessage)) .forEach(this::printResult); } private void printResult(CompletableFuture\u003cString\u003e future) { future.thenRun(() -\u003e System.out.println(future.join())); } } My what a beauty! In the above class, we create a stream of ten elements to call our async service ten times, make sure that we handle exceptions and print each result on the console.\nPlease, notice that nothing is blocking in the above code. The join() method will wait for a result but since we are calling it in a callback after completion, we get a fully asynchronous code.\nThis code will produce the following output, printing each lines at different timings:\nasync-7 - gut de async-5 - konnichiwa async-4 - hallo async-2 - hallo async-6 - saluton async-1 - fáilte async-9 - päivää async-0 - hej async-8 - hallo async-3 - saluton Handling timeouts An interesting question with future is how to set a timeout and cancel them if they run late.\nMy solution is to create another executor like this:\nstatic class TimeOutExecutorService extends CompletableExecutors.DelegatingCompletableExecutorService { private final Duration timeout; private final ScheduledExecutorService schedulerExecutor; TimeOutExecutorService(ExecutorService delegate, Duration timeout) { super(delegate); this.timeout = timeout; schedulerExecutor = Executors.newScheduledThreadPool(1); } @Override public \u003cT\u003e CompletableFuture\u003cT\u003e submit(Callable\u003cT\u003e task) { CompletableFuture\u003cT\u003e cf = new CompletableFuture\u003c\u003e(); Future\u003c?\u003e future = delegate.submit(() -\u003e { try { cf.complete(task.call()); } catch (CancellationException e) { cf.cancel(true); } catch (Throwable ex) { cf.completeExceptionally(ex); } }); schedulerExecutor.schedule(() -\u003e { if (!cf.isDone()) { cf.completeExceptionally(new TimeoutException(\"Timeout after \" + timeout)); future.cancel(true); } }, timeout.toMillis(), TimeUnit.MILLISECONDS); return cf; } } This implementation was inspired by a discussion on stackoverflow.\nWe can now create a new executor as a Spring bean:\n@Bean(name = \"timed\") public Executor timeoutExecutor() { ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(\"timed-%d\").build(); return TimedCompletables.timed(Executors.newFixedThreadPool(10, threadFactory), Duration.ofSeconds(2)); } An use it like this:\n@Async(\"timed\") public CompletableFuture\u003cString\u003e asyncTimeoutGreeting() { AsyncUtil.randomSleep(3000, TimeUnit.MILLISECONDS); String result = AsyncUtil.getThreadName() + \" - \" + random(greetings); return CompletableFuture.completedFuture(result); } Now if we run the application again, about one third of the tasks will time out:\ntimed-4 - saluton timed-3 - hallo timed-7 - saluton timed-8 - fáilte timed-1 - saluton timed-5 - hallo Timeout after PT2S Timeout after PT2S Timeout after PT2S Timeout after PT2S Profiling threads with AOP Let’s add a dependency to spring-boot-starter-aop to automatically profile the execution of our async methods:\n@Aspect @Component public class ServiceProfiler { @Pointcut(\"execution(java.util.concurrent.CompletableFuture completable.service.*.*(..))\") public void serviceMethods() { } @Around(\"serviceMethods()\") public Object profile(ProceedingJoinPoint pjp) throws Throwable { StopWatch stopWatch = new StopWatch(); stopWatch.start(); Object output = pjp.proceed(); stopWatch.stop(); if (output instanceof CompletableFuture) { CompletableFuture future = (CompletableFuture) output; String debug = String.format(\"(%d ms)\", stopWatch.getTotalTimeMillis()); future.thenAccept(o -\u003e System.out.println(o + \" - \" + debug)); } return output; } } This is a bit unnecessary but I used one of the callbacks of CompletableFuture to display the profiling message :)\nConclusion Java 8 CompletableFutures provide an awesome API to deal with async tasks. Too bad that no Executor is able to create them without a bit of code on our part.\nI’m not a concurrency expert so please tell me what you think of this solution in the comments.\n","wordCount":"1224","inLanguage":"en","datePublished":"2015-06-12T00:00:00Z","dateModified":"2015-06-12T00:00:00Z","author":{"@type":"Person","name":"Geoffroy Warin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://geowarin.com/completable-futures-with-spring-async/"},"publisher":{"@type":"Organization","name":"Geowarin","logo":{"@type":"ImageObject","url":"https://geowarin.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://geowarin.com/ accesskey=h title="Geowarin (Alt + H)">Geowarin</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://geowarin.com/archive/ title=Archive><span>Archive</span></a></li><li><a href=https://geowarin.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://geowarin.com/mastering-spring-mvc-4/ title=Book><span>Book</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://geowarin.com/>Home</a>&nbsp;»&nbsp;<a href=https://geowarin.com/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Completable futures with Spring async</h1><div class=post-meta><span title='2015-06-12 00:00:00 +0000 UTC'>June 12, 2015</span>&nbsp;·&nbsp;<span>6 min</span>&nbsp;·&nbsp;<span>Geoffroy Warin</span></div></header><div class=post-content><p>Since version 8, java has a way better abstraction than <code>java.util.Future</code>
called <code>CompletableFuture</code>.
This new API along with the lambdas enables new ways of reasoning with futures
by composing, listening and joining them.</p><p>Futures are traditionally created by submitting tasks to an <code>Executor</code>.
Spring allows declaring one or multiple executors and will submit any method
annotated with <code>@Async</code> as tasks for those executors.</p><p>The big problem is that executors still return <code>Future</code>s and not <code>CompletableFuture</code>s.</p><p>We are going to create our own Executor to solve this problem.
Then we will study a solution to handle timeouts with those futures and
as a bonus, do a little bit of AOP to debug our threads.</p><p>You can see the resulting application <a href=https://github.com/geowarin/spring-completable>on my gihtub</a>.</p><h2 id=creating-an-executor-for-completablefutures>Creating an Executor for CompletableFutures<a hidden class=anchor aria-hidden=true href=#creating-an-executor-for-completablefutures>#</a></h2><p>If you try to return a <code>CompletableFuture</code> from an Async method in Spring,
you will get the following error:</p><pre tabindex=0><code>Caused by: java.lang.ClassCastException: java.util.concurrent.FutureTask cannot be cast to java.util.concurrent.CompletableFuture
</code></pre><p>The idea is to use delegation to decorate an existing instance of <code>ExecutorService</code>.
We will implement the <code>ExecutorService</code> and use type covariance to return
<code>CompletableFuture</code>s instead of <code>Future</code>.</p><p>The following code has been greatly inspired by this <a href=http://binkley.blogspot.fr/2014/12/completablefuture-and-executorservice.html>blog post</a>. Many thanks to Brian Oxley!</p><p>So the first thing we need to do is to create a decorator for an executor service
and delegate every method to that service:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff5c57>static</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>DelegatingExecutorService</span> <span style=color:#ff5c57>implements</span> ExecutorService {
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>protected</span> ExecutorService delegate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#57c7ff>DelegatingExecutorService</span>(ExecutorService executorService) {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>this</span>.<span style=color:#57c7ff>delegate</span> <span style=color:#ff6ac1>=</span> executorService;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span> <span style=color:#ff5c57>public</span> <span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> Future<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>submit</span>(Callable<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> task) {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> delegate.<span style=color:#57c7ff>submit</span>(task);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span> <span style=color:#ff5c57>public</span> <span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> Future<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>submit</span>(Runnable task, T result) {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> delegate.<span style=color:#57c7ff>submit</span>(task, result);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Override and delegate everything</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can create an interface that will extends <code>ExecutorService</code> and return
<code>CompletableFuture</code>s instead of <code>Future</code>s:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#78787e>/**
</span></span></span><span style=display:flex><span><span style=color:#78787e> * DelegatingCompletableExecutorService {@code ExecutorService} to covariantly return {@code
</span></span></span><span style=display:flex><span><span style=color:#78787e> * CompletableFuture} in place of {@code Future}.
</span></span></span><span style=display:flex><span><span style=color:#78787e> */</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>interface</span> <span style=color:#f3f99d>CompletableExecutorService</span> <span style=color:#ff5c57>extends</span> ExecutorService {
</span></span><span style=display:flex><span>    <span style=color:#78787e>/**
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * @return a completable future representing pending completion of the
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * task, never missing
</span></span></span><span style=display:flex><span><span style=color:#78787e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span> <span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> CompletableFuture<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>submit</span>(Callable<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> task);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>/**
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * @return a completable future representing pending completion of the
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * task, never missing
</span></span></span><span style=display:flex><span><span style=color:#78787e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span> <span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> CompletableFuture<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>submit</span>(Runnable task, T result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>/**
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * @return a completable future representing pending completion of the
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * task, never missing
</span></span></span><span style=display:flex><span><span style=color:#78787e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span> CompletableFuture<span style=color:#ff6ac1>&lt;?&gt;</span> submit(Runnable task);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can then implement this new interface using our decorator as a base:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff5c57>static</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>DelegatingCompletableExecutorService</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>extends</span> DelegatingExecutorService
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>implements</span> CompletableExecutorService {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     DelegatingCompletableExecutorService(ExecutorService threads) {
</span></span><span style=display:flex><span>         <span style=color:#ff5c57>super</span>(threads);
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ff9f43>@Override</span> <span style=color:#ff5c57>public</span> <span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> CompletableFuture<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>submit</span>(Callable<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> task) {
</span></span><span style=display:flex><span>         <span style=color:#ff5c57>final</span> CompletableFuture<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> cf <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> CompletableFuture<span style=color:#ff6ac1>&lt;&gt;</span>();
</span></span><span style=display:flex><span>         delegate.<span style=color:#57c7ff>submit</span>(() <span style=color:#ff6ac1>-&gt;</span> {
</span></span><span style=display:flex><span>             <span style=color:#ff6ac1>try</span> {
</span></span><span style=display:flex><span>                 cf.<span style=color:#57c7ff>complete</span>(task.<span style=color:#57c7ff>call</span>());
</span></span><span style=display:flex><span>             } <span style=color:#ff6ac1>catch</span> (CancellationException e) {
</span></span><span style=display:flex><span>                 cf.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>true</span>);
</span></span><span style=display:flex><span>             } <span style=color:#ff6ac1>catch</span> (Exception e) {
</span></span><span style=display:flex><span>                 cf.<span style=color:#57c7ff>completeExceptionally</span>(e);
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>         });
</span></span><span style=display:flex><span>         <span style=color:#ff6ac1>return</span> cf;
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ff9f43>@Override</span> <span style=color:#ff5c57>public</span> <span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> CompletableFuture<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>submit</span>(Runnable task, T result) {
</span></span><span style=display:flex><span>         <span style=color:#ff6ac1>return</span> submit(callable(task, result));
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ff9f43>@Override</span> <span style=color:#ff5c57>public</span> CompletableFuture<span style=color:#ff6ac1>&lt;?&gt;</span> submit(Runnable task) {
</span></span><span style=display:flex><span>         <span style=color:#ff6ac1>return</span> submit(callable(task));
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We also need to create an utility method to create a <code>CompletableExecutorService</code>:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> CompletableExecutorService <span style=color:#57c7ff>completable</span>(ExecutorService delegate) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>new</span> DelegatingCompletableExecutorService(delegate);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>See <a href=https://gist.github.com/geowarin/bc40acd46791aa114c30>this gist</a> for the final result.</p><h2 id=creating-an-async-service>Creating an async service<a hidden class=anchor aria-hidden=true href=#creating-an-async-service>#</a></h2><p>To enable asynchronous methods in Spring, you will need this kind of configuration
class:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff9f43>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#ff9f43>@EnableAsync</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>SpringAsyncConfig</span> <span style=color:#ff5c57>implements</span> AsyncConfigurer {
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>protected</span> <span style=color:#ff5c57>final</span> Log logger <span style=color:#ff6ac1>=</span> LogFactory.<span style=color:#57c7ff>getLog</span>(getClass());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> Executor <span style=color:#57c7ff>getAsyncExecutor</span>() {
</span></span><span style=display:flex><span>        ThreadFactory threadFactory <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> ThreadFactoryBuilder().<span style=color:#57c7ff>setNameFormat</span>(<span style=color:#5af78e>&#34;async-%d&#34;</span>).<span style=color:#57c7ff>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> CompletableExecutors.<span style=color:#57c7ff>completable</span>(Executors.<span style=color:#57c7ff>newFixedThreadPool</span>(10, threadFactory));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> AsyncUncaughtExceptionHandler <span style=color:#57c7ff>getAsyncUncaughtExceptionHandler</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> (ex, method, params) <span style=color:#ff6ac1>-&gt;</span> logger.<span style=color:#57c7ff>error</span>(<span style=color:#5af78e>&#34;Uncaught async error&#34;</span>, ex);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see, we can specify which executor will handle our <code>@Async</code> methods.</p><p>We can now return <code>CompletableFuture</code>s from our services!</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff9f43>@Service</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>AsyncService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>static</span> String<span style=color:#ff6ac1>[]</span> greetings <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> String<span style=color:#ff6ac1>[]</span>{
</span></span><span style=display:flex><span>            <span style=color:#5af78e>&#34;hallo&#34;</span>, <span style=color:#5af78e>&#34;hallo&#34;</span>, <span style=color:#5af78e>&#34;hej&#34;</span>, <span style=color:#5af78e>&#34;hej&#34;</span>, <span style=color:#5af78e>&#34;bonjour&#34;</span>, <span style=color:#5af78e>&#34;hola&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#5af78e>&#34;ciao&#34;</span>, <span style=color:#5af78e>&#34;shalom&#34;</span>, <span style=color:#5af78e>&#34;fáilte&#34;</span>, <span style=color:#5af78e>&#34;kaixo&#34;</span>, <span style=color:#5af78e>&#34;konnichiwa&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#5af78e>&#34;saluton&#34;</span>, <span style=color:#5af78e>&#34;päivää&#34;</span>, <span style=color:#5af78e>&#34;selamat pagi&#34;</span>, <span style=color:#5af78e>&#34;gut de&#34;</span>, <span style=color:#5af78e>&#34;olá&#34;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Async</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> CompletableFuture<span style=color:#ff6ac1>&lt;</span>String<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>asyncGreeting</span>() {
</span></span><span style=display:flex><span>        AsyncUtil.<span style=color:#57c7ff>randomSleep</span>(3000, TimeUnit.<span style=color:#57c7ff>MILLISECONDS</span>);
</span></span><span style=display:flex><span>        String result <span style=color:#ff6ac1>=</span> AsyncUtil.<span style=color:#57c7ff>getThreadName</span>() <span style=color:#ff6ac1>+</span> <span style=color:#5af78e>&#34; - &#34;</span> <span style=color:#ff6ac1>+</span> random(greetings);
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> CompletableFuture.<span style=color:#57c7ff>completedFuture</span>(result);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@SafeVarargs</span> <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>final</span> <span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> T <span style=color:#57c7ff>random</span>(T... elements) {
</span></span><span style=display:flex><span>        LinkedList<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> greetings <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> LinkedList<span style=color:#ff6ac1>&lt;&gt;</span>(Arrays.<span style=color:#57c7ff>asList</span>(elements));
</span></span><span style=display:flex><span>        Collections.<span style=color:#57c7ff>shuffle</span>(greetings, ThreadLocalRandom.<span style=color:#57c7ff>current</span>());
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> greetings.<span style=color:#57c7ff>getFirst</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here is the <code>AsyncUtil</code> class in case you are wondering what&rsquo;s going on:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>AsyncUtil</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>randomSleep</span>(<span style=color:#9aedfe>int</span> duration, TimeUnit timeUnit) {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>try</span> {
</span></span><span style=display:flex><span>            timeUnit.<span style=color:#57c7ff>sleep</span>(ThreadLocalRandom.<span style=color:#57c7ff>current</span>().<span style=color:#57c7ff>nextInt</span>(duration));
</span></span><span style=display:flex><span>        } <span style=color:#ff6ac1>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            Throwables.<span style=color:#57c7ff>propagate</span>(e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> String <span style=color:#57c7ff>getThreadName</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> Thread.<span style=color:#57c7ff>currentThread</span>().<span style=color:#57c7ff>getName</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Our service will say hello in a random language within 3 seconds of time.
How do we handle the result?</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>Runner</span> <span style=color:#ff5c57>implements</span> CommandLineRunner {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> AsyncService asyncService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span> <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>run</span>(String... args) <span style=color:#ff5c57>throws</span> Exception {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        IntStream.<span style=color:#57c7ff>rangeClosed</span>(1, 10)
</span></span><span style=display:flex><span>                .<span style=color:#57c7ff>mapToObj</span>(__ <span style=color:#ff6ac1>-&gt;</span> asyncService.<span style=color:#57c7ff>asyncGreeting</span>().<span style=color:#57c7ff>exceptionally</span>(Throwable::getMessage))
</span></span><span style=display:flex><span>                .<span style=color:#57c7ff>forEach</span>(<span style=color:#ff6ac1>this</span>::printResult);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>printResult</span>(CompletableFuture<span style=color:#ff6ac1>&lt;</span>String<span style=color:#ff6ac1>&gt;</span> future) {
</span></span><span style=display:flex><span>        future.<span style=color:#57c7ff>thenRun</span>(() <span style=color:#ff6ac1>-&gt;</span> System.<span style=color:#57c7ff>out</span>.<span style=color:#57c7ff>println</span>(future.<span style=color:#57c7ff>join</span>()));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>My what a beauty! In the above class, we create a stream of ten elements
to call our async service ten times, make sure that we handle exceptions and
print each result on the console.</p><p>Please, notice that <strong>nothing is blocking</strong> in the above code.
The <code>join()</code> method will wait for a result but since we are calling it in a
callback after completion, we get a fully asynchronous code.</p><p>This code will produce the following output, printing each lines at different
timings:</p><pre tabindex=0><code>async-7 - gut de
async-5 - konnichiwa
async-4 - hallo
async-2 - hallo
async-6 - saluton
async-1 - fáilte
async-9 - päivää
async-0 - hej
async-8 - hallo
async-3 - saluton
</code></pre><h2 id=handling-timeouts>Handling timeouts<a hidden class=anchor aria-hidden=true href=#handling-timeouts>#</a></h2><p>An interesting question with future is how to set a timeout and cancel them
if they run late.</p><p>My solution is to create another executor like this:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff5c57>static</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>TimeOutExecutorService</span> <span style=color:#ff5c57>extends</span> CompletableExecutors.<span style=color:#57c7ff>DelegatingCompletableExecutorService</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>final</span> Duration timeout;
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>final</span> ScheduledExecutorService schedulerExecutor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    TimeOutExecutorService(ExecutorService delegate, Duration timeout) {
</span></span><span style=display:flex><span>        <span style=color:#ff5c57>super</span>(delegate);
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>this</span>.<span style=color:#57c7ff>timeout</span> <span style=color:#ff6ac1>=</span> timeout;
</span></span><span style=display:flex><span>        schedulerExecutor <span style=color:#ff6ac1>=</span> Executors.<span style=color:#57c7ff>newScheduledThreadPool</span>(1);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span> <span style=color:#ff5c57>public</span> <span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> CompletableFuture<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>submit</span>(Callable<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> task) {
</span></span><span style=display:flex><span>        CompletableFuture<span style=color:#ff6ac1>&lt;</span>T<span style=color:#ff6ac1>&gt;</span> cf <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> CompletableFuture<span style=color:#ff6ac1>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        Future<span style=color:#ff6ac1>&lt;?&gt;</span> future <span style=color:#ff6ac1>=</span> delegate.<span style=color:#57c7ff>submit</span>(() <span style=color:#ff6ac1>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>try</span> {
</span></span><span style=display:flex><span>                cf.<span style=color:#57c7ff>complete</span>(task.<span style=color:#57c7ff>call</span>());
</span></span><span style=display:flex><span>            } <span style=color:#ff6ac1>catch</span> (CancellationException e) {
</span></span><span style=display:flex><span>                cf.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>true</span>);
</span></span><span style=display:flex><span>            } <span style=color:#ff6ac1>catch</span> (Throwable ex) {
</span></span><span style=display:flex><span>                cf.<span style=color:#57c7ff>completeExceptionally</span>(ex);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        schedulerExecutor.<span style=color:#57c7ff>schedule</span>(() <span style=color:#ff6ac1>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>if</span> (<span style=color:#ff6ac1>!</span>cf.<span style=color:#57c7ff>isDone</span>()) {
</span></span><span style=display:flex><span>                cf.<span style=color:#57c7ff>completeExceptionally</span>(<span style=color:#ff6ac1>new</span> TimeoutException(<span style=color:#5af78e>&#34;Timeout after &#34;</span> <span style=color:#ff6ac1>+</span> timeout));
</span></span><span style=display:flex><span>                future.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>true</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }, timeout.<span style=color:#57c7ff>toMillis</span>(), TimeUnit.<span style=color:#57c7ff>MILLISECONDS</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> cf;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This implementation was inspired by <a href=http://stackoverflow.com/questions/23575067/timeout-with-default-value-in-java-8-completablefuture/24457111#24457111>a discussion</a> on stackoverflow.</p><p>We can now create a new executor as a Spring bean:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff9f43>@Bean</span>(name <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;timed&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> Executor <span style=color:#57c7ff>timeoutExecutor</span>() {
</span></span><span style=display:flex><span>    ThreadFactory threadFactory <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> ThreadFactoryBuilder().<span style=color:#57c7ff>setNameFormat</span>(<span style=color:#5af78e>&#34;timed-%d&#34;</span>).<span style=color:#57c7ff>build</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> TimedCompletables.<span style=color:#57c7ff>timed</span>(Executors.<span style=color:#57c7ff>newFixedThreadPool</span>(10, threadFactory), Duration.<span style=color:#57c7ff>ofSeconds</span>(2));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>An use it like this:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff9f43>@Async</span>(<span style=color:#5af78e>&#34;timed&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> CompletableFuture<span style=color:#ff6ac1>&lt;</span>String<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>asyncTimeoutGreeting</span>() {
</span></span><span style=display:flex><span>    AsyncUtil.<span style=color:#57c7ff>randomSleep</span>(3000, TimeUnit.<span style=color:#57c7ff>MILLISECONDS</span>);
</span></span><span style=display:flex><span>    String result <span style=color:#ff6ac1>=</span> AsyncUtil.<span style=color:#57c7ff>getThreadName</span>() <span style=color:#ff6ac1>+</span> <span style=color:#5af78e>&#34; - &#34;</span> <span style=color:#ff6ac1>+</span> random(greetings);
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>return</span> CompletableFuture.<span style=color:#57c7ff>completedFuture</span>(result);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now if we run the application again, about one third of the tasks will time out:</p><pre tabindex=0><code>timed-4 - saluton
timed-3 - hallo
timed-7 - saluton
timed-8 - fáilte
timed-1 - saluton
timed-5 - hallo
Timeout after PT2S
Timeout after PT2S
Timeout after PT2S
Timeout after PT2S
</code></pre><h2 id=profiling-threads-with-aop>Profiling threads with AOP<a hidden class=anchor aria-hidden=true href=#profiling-threads-with-aop>#</a></h2><p>Let&rsquo;s add a dependency to <code>spring-boot-starter-aop</code> to automatically profile the
execution of our async methods:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff9f43>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#ff9f43>@Component</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>ServiceProfiler</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff9f43>@Pointcut</span>(<span style=color:#5af78e>&#34;execution(java.util.concurrent.CompletableFuture completable.service.*.*(..))&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>serviceMethods</span>() {
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff9f43>@Around</span>(<span style=color:#5af78e>&#34;serviceMethods()&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#ff5c57>public</span> Object <span style=color:#57c7ff>profile</span>(ProceedingJoinPoint pjp) <span style=color:#ff5c57>throws</span> Throwable {
</span></span><span style=display:flex><span>       StopWatch stopWatch <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> StopWatch();
</span></span><span style=display:flex><span>       stopWatch.<span style=color:#57c7ff>start</span>();
</span></span><span style=display:flex><span>       Object output <span style=color:#ff6ac1>=</span> pjp.<span style=color:#57c7ff>proceed</span>();
</span></span><span style=display:flex><span>       stopWatch.<span style=color:#57c7ff>stop</span>();
</span></span><span style=display:flex><span>       <span style=color:#ff6ac1>if</span> (output <span style=color:#ff6ac1>instanceof</span> CompletableFuture) {
</span></span><span style=display:flex><span>           CompletableFuture future <span style=color:#ff6ac1>=</span> (CompletableFuture) output;
</span></span><span style=display:flex><span>           String debug <span style=color:#ff6ac1>=</span> String.<span style=color:#57c7ff>format</span>(<span style=color:#5af78e>&#34;(%d ms)&#34;</span>, stopWatch.<span style=color:#57c7ff>getTotalTimeMillis</span>());
</span></span><span style=display:flex><span>           future.<span style=color:#57c7ff>thenAccept</span>(o <span style=color:#ff6ac1>-&gt;</span> System.<span style=color:#57c7ff>out</span>.<span style=color:#57c7ff>println</span>(o <span style=color:#ff6ac1>+</span> <span style=color:#5af78e>&#34; - &#34;</span> <span style=color:#ff6ac1>+</span> debug));
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#ff6ac1>return</span> output;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is a bit unnecessary but I used one of the callbacks of <code>CompletableFuture</code>
to display the profiling message :)</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Java 8 <code>CompletableFuture</code>s provide an awesome API to deal with async
tasks. Too bad that no Executor is able to create them without a bit of code
on our part.</p><p>I&rsquo;m not a concurrency expert so please tell me what you think of this solution
in the comments.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://geowarin.com/tags/spring/>Spring</a></li><li><a href=https://geowarin.com/tags/futures/>Futures</a></li><li><a href=https://geowarin.com/tags/async/>Async</a></li><li><a href=https://geowarin.com/tags/featured/>Featured</a></li></ul><nav class=paginav><a class=prev href=https://geowarin.com/spring-boot-and-react-hot-loader/><span class=title>« Prev</span><br><span>Spring Boot and React hot loader</span>
</a><a class=next href=https://geowarin.com/the-missing-fish-shell-tutorial/><span class=title>Next »</span><br><span>The missing fish shell tutorial</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on x" href="https://x.com/intent/tweet/?text=Completable%20futures%20with%20Spring%20async&amp;url=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f&amp;hashtags=spring%2cfutures%2casync%2cfeatured"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f&amp;title=Completable%20futures%20with%20Spring%20async&amp;summary=Completable%20futures%20with%20Spring%20async&amp;source=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f&title=Completable%20futures%20with%20Spring%20async"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li></ul></footer><section class=comments><script>const theme=document.documentElement.dataset.theme==="light"?"github-light":"photon-dark";let s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","geowarin/geowarin.github.io"),s.setAttribute("issue-term","title"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("section.comments").innerHTML="",document.querySelector("section.comments").appendChild(s)</script></section></article></main><footer class=footer><span>&copy; 2026 <a href=https://geowarin.com/>Geowarin</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><div id=img-overlay style=display:none><button class=close>X</button><div class=overlay-content><img id=img-content><div id=img-caption></div></div></div><script>const figures=document.querySelectorAll("figure > img"),overlay=document.querySelector("#img-overlay");let currentIndex=0;function showOverlay(e){currentIndex=Math.min(Math.max(e,0),figures.length-1);const t=figures[currentIndex];overlay.style.display="flex",document.querySelector("#img-content").src=t.src;const n=t.parentNode.querySelector("figcaption");document.querySelector("#img-caption").innerHTML=n?n.textContent:""}figures.forEach((e,t)=>{e.style.cursor="pointer",e.addEventListener("click",()=>showOverlay(t))});function closeOverlay(){overlay.style.display="none"}document.addEventListener("keydown",e=>{if(overlay.style.display==="none")return;e.key==="Escape"?closeOverlay():e.key==="ArrowRight"?showOverlay(++currentIndex):e.key==="ArrowLeft"&&showOverlay(--currentIndex)}),overlay.addEventListener("click",e=>{e.target===e.currentTarget&&closeOverlay()}),document.querySelector("#img-overlay .close").addEventListener("click",closeOverlay)</script><script>const footnotes=document.querySelectorAll(".footnote-ref");for(const e of footnotes){const t=new URL(e.href).hash.slice(1);e.title=document.getElementById(t)?.textContent.trim().replaceAll("↩︎","")}</script><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>