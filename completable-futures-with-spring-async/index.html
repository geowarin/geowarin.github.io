<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Completable futures with Spring async | Geowarin</title>
<meta name=keywords content="spring,futures,async,featured">
<meta name=description content="Use Java 8 new CompletableFuture with Spring async">
<meta name=author content>
<link rel=canonical href=https://geowarin.com/completable-futures-with-spring-async/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.6f60056d44d3f7eb69a4bc6c332b59960f3a995802bded244750232f33713c49.css integrity="sha256-b2AFbUTT9+tppLxsMytZlg86mVgCve0kR1AjLzNxPEk=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://geowarin.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://geowarin.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://geowarin.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://geowarin.com/apple-touch-icon.png>
<link rel=mask-icon href=https://geowarin.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Completable futures with Spring async">
<meta property="og:description" content="Use Java 8 new CompletableFuture with Spring async">
<meta property="og:type" content="article">
<meta property="og:url" content="https://geowarin.com/completable-futures-with-spring-async/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2015-06-12T00:00:00+00:00">
<meta property="article:modified_time" content="2015-06-12T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Completable futures with Spring async">
<meta name=twitter:description content="Use Java 8 new CompletableFuture with Spring async">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://geowarin.com/post/"},{"@type":"ListItem","position":3,"name":"Completable futures with Spring async","item":"https://geowarin.com/completable-futures-with-spring-async/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Completable futures with Spring async","name":"Completable futures with Spring async","description":"Use Java 8 new CompletableFuture with Spring async","keywords":["spring","futures","async","featured"],"articleBody":"Since version 8, java has a way better abstraction than java.util.Future called CompletableFuture. This new API along with the lambdas enables new ways of reasoning with futures by composing, listening and joining them.\nFutures are traditionally created by submitting tasks to an Executor. Spring allows declaring one or multiple executors and will submit any method annotated with @Async as tasks for those executors.\nThe big problem is that executors still return Futures and not CompletableFutures.\nWe are going to create our own Executor to solve this problem. Then we will study a solution to handle timeouts with those futures and as a bonus, do a little bit of AOP to debug our threads.\nYou can see the resulting application on my gihtub.\nCreating an Executor for CompletableFutures If you try to return a CompletableFuture from an Async method in Spring, you will get the following error:\nCaused by: java.lang.ClassCastException: java.util.concurrent.FutureTask cannot be cast to java.util.concurrent.CompletableFuture The idea is to use delegation to decorate an existing instance of ExecutorService. We will implement the ExecutorService and use type covariance to return CompletableFutures instead of Future.\nThe following code has been greatly inspired by this blog post. Many thanks to Brian Oxley!\nSo the first thing we need to do is to create a decorator for an executor service and delegate every method to that service:\nstatic class DelegatingExecutorService implements ExecutorService { protected ExecutorService delegate; public DelegatingExecutorService(ExecutorService executorService) { this.delegate = executorService; } @Override public T FutureT submit(CallableT task) { return delegate.submit(task); } @Override public T FutureT submit(Runnable task, T result) { return delegate.submit(task, result); } // Override and delegate everything } We can create an interface that will extends ExecutorService and return CompletableFutures instead of Futures:\n/** * DelegatingCompletableExecutorService {@code ExecutorService} to covariantly return {@code * CompletableFuture} in place of {@code Future}. */ public interface CompletableExecutorService extends ExecutorService { /** * @return a completable future representing pending completion of the * task, never missing */ @Override T CompletableFutureT submit(CallableT task); /** * @return a completable future representing pending completion of the * task, never missing */ @Override T CompletableFutureT submit(Runnable task, T result); /** * @return a completable future representing pending completion of the * task, never missing */ @Override CompletableFuture submit(Runnable task); } We can then implement this new interface using our decorator as a base:\nstatic class DelegatingCompletableExecutorService extends DelegatingExecutorService implements CompletableExecutorService { DelegatingCompletableExecutorService(ExecutorService threads) { super(threads); } @Override public T CompletableFutureT submit(CallableT task) { final CompletableFutureT cf = new CompletableFuture(); delegate.submit(() - { try { cf.complete(task.call()); } catch (CancellationException e) { cf.cancel(true); } catch (Exception e) { cf.completeExceptionally(e); } }); return cf; } @Override public T CompletableFutureT submit(Runnable task, T result) { return submit(callable(task, result)); } @Override public CompletableFuture submit(Runnable task) { return submit(callable(task)); } } We also need to create an utility method to create a CompletableExecutorService:\npublic static CompletableExecutorService completable(ExecutorService delegate) { return new DelegatingCompletableExecutorService(delegate); } See this gist for the final result.\nCreating an async service To enable asynchronous methods in Spring, you will need this kind of configuration class:\n@Configuration @EnableAsync public class SpringAsyncConfig implements AsyncConfigurer { protected final Log logger = LogFactory.getLog(getClass()); @Override public Executor getAsyncExecutor() { ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(\"async-%d\").build(); return CompletableExecutors.completable(Executors.newFixedThreadPool(10, threadFactory)); } @Override public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() { return (ex, method, params) - logger.error(\"Uncaught async error\", ex); } } As you can see, we can specify which executor will handle our @Async methods.\nWe can now return CompletableFutures from our services!\n@Service public class AsyncService { private static String[] greetings = new String[]{ \"hallo\", \"hallo\", \"hej\", \"hej\", \"bonjour\", \"hola\", \"ciao\", \"shalom\", \"fáilte\", \"kaixo\", \"konnichiwa\", \"saluton\", \"päivää\", \"selamat pagi\", \"gut de\", \"olá\" }; @Async public CompletableFutureString asyncGreeting() { AsyncUtil.randomSleep(3000, TimeUnit.MILLISECONDS); String result = AsyncUtil.getThreadName() + \" - \" + random(greetings); return CompletableFuture.completedFuture(result); } @SafeVarargs public final T T random(T... elements) { LinkedListT greetings = new LinkedList(Arrays.asList(elements)); Collections.shuffle(greetings, ThreadLocalRandom.current()); return greetings.getFirst(); } } Here is the AsyncUtil class in case you are wondering what’s going on:\npublic class AsyncUtil { public static void randomSleep(int duration, TimeUnit timeUnit) { try { timeUnit.sleep(ThreadLocalRandom.current().nextInt(duration)); } catch (InterruptedException e) { Throwables.propagate(e); } } public static String getThreadName() { return Thread.currentThread().getName(); } } Our service will say hello in a random language within 3 seconds of time. How do we handle the result?\npublic class Runner implements CommandLineRunner { @Autowired private AsyncService asyncService; @Override public void run(String... args) throws Exception { IntStream.rangeClosed(1, 10) .mapToObj(__ - asyncService.asyncGreeting().exceptionally(Throwable::getMessage)) .forEach(this::printResult); } private void printResult(CompletableFutureString future) { future.thenRun(() - System.out.println(future.join())); } } My what a beauty! In the above class, we create a stream of ten elements to call our async service ten times, make sure that we handle exceptions and print each result on the console.\nPlease, notice that nothing is blocking in the above code. The join() method will wait for a result but since we are calling it in a callback after completion, we get a fully asynchronous code.\nThis code will produce the following output, printing each lines at different timings:\nasync-7 - gut de async-5 - konnichiwa async-4 - hallo async-2 - hallo async-6 - saluton async-1 - fáilte async-9 - päivää async-0 - hej async-8 - hallo async-3 - saluton Handling timeouts An interesting question with future is how to set a timeout and cancel them if they run late.\nMy solution is to create another executor like this:\nstatic class TimeOutExecutorService extends CompletableExecutors.DelegatingCompletableExecutorService { private final Duration timeout; private final ScheduledExecutorService schedulerExecutor; TimeOutExecutorService(ExecutorService delegate, Duration timeout) { super(delegate); this.timeout = timeout; schedulerExecutor = Executors.newScheduledThreadPool(1); } @Override public T CompletableFutureT submit(CallableT task) { CompletableFutureT cf = new CompletableFuture(); Future future = delegate.submit(() - { try { cf.complete(task.call()); } catch (CancellationException e) { cf.cancel(true); } catch (Throwable ex) { cf.completeExceptionally(ex); } }); schedulerExecutor.schedule(() - { if (!cf.isDone()) { cf.completeExceptionally(new TimeoutException(\"Timeout after \" + timeout)); future.cancel(true); } }, timeout.toMillis(), TimeUnit.MILLISECONDS); return cf; } } This implementation was inspired by a discussion on stackoverflow.\nWe can now create a new executor as a Spring bean:\n@Bean(name = \"timed\") public Executor timeoutExecutor() { ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(\"timed-%d\").build(); return TimedCompletables.timed(Executors.newFixedThreadPool(10, threadFactory), Duration.ofSeconds(2)); } An use it like this:\n@Async(\"timed\") public CompletableFutureString asyncTimeoutGreeting() { AsyncUtil.randomSleep(3000, TimeUnit.MILLISECONDS); String result = AsyncUtil.getThreadName() + \" - \" + random(greetings); return CompletableFuture.completedFuture(result); } Now if we run the application again, about one third of the tasks will time out:\ntimed-4 - saluton timed-3 - hallo timed-7 - saluton timed-8 - fáilte timed-1 - saluton timed-5 - hallo Timeout after PT2S Timeout after PT2S Timeout after PT2S Timeout after PT2S Profiling threads with AOP Let’s add a dependency to spring-boot-starter-aop to automatically profile the execution of our async methods:\n@Aspect @Component public class ServiceProfiler { @Pointcut(\"execution(java.util.concurrent.CompletableFuture completable.service.*.*(..))\") public void serviceMethods() { } @Around(\"serviceMethods()\") public Object profile(ProceedingJoinPoint pjp) throws Throwable { StopWatch stopWatch = new StopWatch(); stopWatch.start(); Object output = pjp.proceed(); stopWatch.stop(); if (output instanceof CompletableFuture) { CompletableFuture future = (CompletableFuture) output; String debug = String.format(\"(%d ms)\", stopWatch.getTotalTimeMillis()); future.thenAccept(o - System.out.println(o + \" - \" + debug)); } return output; } } This is a bit unnecessary but I used one of the callbacks of CompletableFuture to display the profiling message :)\nConclusion Java 8 CompletableFutures provide an awesome API to deal with async tasks. Too bad that no Executor is able to create them without a bit of code on our part.\nI’m not a concurrency expert so please tell me what you think of this solution in the comments.\n","wordCount":"1224","inLanguage":"en","datePublished":"2015-06-12T00:00:00Z","dateModified":"2015-06-12T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://geowarin.com/completable-futures-with-spring-async/"},"publisher":{"@type":"Organization","name":"Geowarin","logo":{"@type":"ImageObject","url":"https://geowarin.com/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://geowarin.com accesskey=h title="Geowarin (Alt + H)">Geowarin</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://geowarin.com/archive/ title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://geowarin.com/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://geowarin.com/mastering-spring-mvc-4/ title=Book>
<span>Book</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://geowarin.com>Home</a>&nbsp;»&nbsp;<a href=https://geowarin.com/post/>Posts</a></div>
<h1 class=post-title>
Completable futures with Spring async
</h1>
<div class=post-meta><span title="2015-06-12 00:00:00 +0000 UTC">June 12, 2015</span>&nbsp;·&nbsp;6 min
</div>
</header>
<div class=post-content><p>Since version 8, java has a way better abstraction than <code>java.util.Future</code>
called <code>CompletableFuture</code>.
This new API along with the lambdas enables new ways of reasoning with futures
by composing, listening and joining them.</p>
<p>Futures are traditionally created by submitting tasks to an <code>Executor</code>.
Spring allows declaring one or multiple executors and will submit any method
annotated with <code>@Async</code> as tasks for those executors.</p>
<p>The big problem is that executors still return <code>Future</code>s and not <code>CompletableFuture</code>s.</p>
<p>We are going to create our own Executor to solve this problem.
Then we will study a solution to handle timeouts with those futures and
as a bonus, do a little bit of AOP to debug our threads.</p>
<p>You can see the resulting application <a href=https://github.com/geowarin/spring-completable>on my gihtub</a>.</p>
<h2 id=creating-an-executor-for-completablefutures>Creating an Executor for CompletableFutures<a hidden class=anchor aria-hidden=true href=#creating-an-executor-for-completablefutures>#</a></h2>
<p>If you try to return a <code>CompletableFuture</code> from an Async method in Spring,
you will get the following error:</p>
<pre tabindex=0><code>Caused by: java.lang.ClassCastException: java.util.concurrent.FutureTask cannot be cast to java.util.concurrent.CompletableFuture
</code></pre><p>The idea is to use delegation to decorate an existing instance of <code>ExecutorService</code>.
We will implement the <code>ExecutorService</code> and use type covariance to return
<code>CompletableFuture</code>s instead of <code>Future</code>.</p>
<p>The following code has been greatly inspired by this <a href=http://binkley.blogspot.fr/2014/12/completablefuture-and-executorservice.html>blog post</a>. Many thanks to Brian Oxley!</p>
<p>So the first thing we need to do is to create a decorator for an executor service
and delegate every method to that service:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DelegatingExecutorService</span> <span style=color:#66d9ef>implements</span> ExecutorService <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>protected</span> ExecutorService delegate<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DelegatingExecutorService</span><span style=color:#f92672>(</span>ExecutorService executorService<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>delegate</span> <span style=color:#f92672>=</span> executorService<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Future<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>Callable<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> task<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>task<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Future<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>Runnable task<span style=color:#f92672>,</span> T result<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>task<span style=color:#f92672>,</span> result<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>// Override and delegate everything
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><p>We can create an interface that will extends <code>ExecutorService</code> and return
<code>CompletableFuture</code>s instead of <code>Future</code>s:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/**
</span><span style=color:#75715e> * DelegatingCompletableExecutorService {@code ExecutorService} to covariantly return {@code
</span><span style=color:#75715e> * CompletableFuture} in place of {@code Future}.
</span><span style=color:#75715e> */</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CompletableExecutorService</span> <span style=color:#66d9ef>extends</span> ExecutorService <span style=color:#f92672>{</span>
    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * @return a completable future representing pending completion of the
</span><span style=color:#75715e>     * task, never missing
</span><span style=color:#75715e>     */</span>
    <span style=color:#a6e22e>@Override</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> CompletableFuture<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>Callable<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> task<span style=color:#f92672>);</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * @return a completable future representing pending completion of the
</span><span style=color:#75715e>     * task, never missing
</span><span style=color:#75715e>     */</span>
    <span style=color:#a6e22e>@Override</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> CompletableFuture<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>Runnable task<span style=color:#f92672>,</span> T result<span style=color:#f92672>);</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * @return a completable future representing pending completion of the
</span><span style=color:#75715e>     * task, never missing
</span><span style=color:#75715e>     */</span>
    <span style=color:#a6e22e>@Override</span> CompletableFuture<span style=color:#f92672>&lt;?&gt;</span> submit<span style=color:#f92672>(</span>Runnable task<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>We can then implement this new interface using our decorator as a base:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DelegatingCompletableExecutorService</span>
    <span style=color:#66d9ef>extends</span> DelegatingExecutorService
    <span style=color:#66d9ef>implements</span> CompletableExecutorService <span style=color:#f92672>{</span>

     DelegatingCompletableExecutorService<span style=color:#f92672>(</span>ExecutorService threads<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
         <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>threads<span style=color:#f92672>);</span>
     <span style=color:#f92672>}</span>

     <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> CompletableFuture<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>Callable<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> task<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
         <span style=color:#66d9ef>final</span> CompletableFuture<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> cf <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompletableFuture<span style=color:#f92672>&lt;&gt;();</span>
         delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
             <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                 cf<span style=color:#f92672>.</span><span style=color:#a6e22e>complete</span><span style=color:#f92672>(</span>task<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>());</span>
             <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>CancellationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                 cf<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
             <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                 cf<span style=color:#f92672>.</span><span style=color:#a6e22e>completeExceptionally</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
             <span style=color:#f92672>}</span>
         <span style=color:#f92672>});</span>
         <span style=color:#66d9ef>return</span> cf<span style=color:#f92672>;</span>
     <span style=color:#f92672>}</span>

     <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> CompletableFuture<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>Runnable task<span style=color:#f92672>,</span> T result<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
         <span style=color:#66d9ef>return</span> submit<span style=color:#f92672>(</span>callable<span style=color:#f92672>(</span>task<span style=color:#f92672>,</span> result<span style=color:#f92672>));</span>
     <span style=color:#f92672>}</span>

     <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> CompletableFuture<span style=color:#f92672>&lt;?&gt;</span> submit<span style=color:#f92672>(</span>Runnable task<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
         <span style=color:#66d9ef>return</span> submit<span style=color:#f92672>(</span>callable<span style=color:#f92672>(</span>task<span style=color:#f92672>));</span>
     <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>We also need to create an utility method to create a <code>CompletableExecutorService</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> CompletableExecutorService <span style=color:#a6e22e>completable</span><span style=color:#f92672>(</span>ExecutorService delegate<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DelegatingCompletableExecutorService<span style=color:#f92672>(</span>delegate<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>See <a href=https://gist.github.com/geowarin/bc40acd46791aa114c30>this gist</a> for the final result.</p>
<h2 id=creating-an-async-service>Creating an async service<a hidden class=anchor aria-hidden=true href=#creating-an-async-service>#</a></h2>
<p>To enable asynchronous methods in Spring, you will need this kind of configuration
class:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@EnableAsync</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpringAsyncConfig</span> <span style=color:#66d9ef>implements</span> AsyncConfigurer <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>final</span> Log logger <span style=color:#f92672>=</span> LogFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLog</span><span style=color:#f92672>(</span>getClass<span style=color:#f92672>());</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Executor <span style=color:#a6e22e>getAsyncExecutor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        ThreadFactory threadFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadFactoryBuilder<span style=color:#f92672>().</span><span style=color:#a6e22e>setNameFormat</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;async-%d&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>return</span> CompletableExecutors<span style=color:#f92672>.</span><span style=color:#a6e22e>completable</span><span style=color:#f92672>(</span>Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>10<span style=color:#f92672>,</span> threadFactory<span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> AsyncUncaughtExceptionHandler <span style=color:#a6e22e>getAsyncUncaughtExceptionHandler</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>ex<span style=color:#f92672>,</span> method<span style=color:#f92672>,</span> params<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> logger<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Uncaught async error&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>As you can see, we can specify which executor will handle our <code>@Async</code> methods.</p>
<p>We can now return <code>CompletableFuture</code>s from our services!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Service</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AsyncService</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String<span style=color:#f92672>[]</span> greetings <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]{</span>
            <span style=color:#e6db74>&#34;hallo&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;hallo&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;hej&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;hej&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;bonjour&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;hola&#34;</span><span style=color:#f92672>,</span>
            <span style=color:#e6db74>&#34;ciao&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;shalom&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;fáilte&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;kaixo&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;konnichiwa&#34;</span><span style=color:#f92672>,</span>
            <span style=color:#e6db74>&#34;saluton&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;päivää&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;selamat pagi&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;gut de&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;olá&#34;</span>
    <span style=color:#f92672>};</span>

    <span style=color:#a6e22e>@Async</span>
    <span style=color:#66d9ef>public</span> CompletableFuture<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>asyncGreeting</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        AsyncUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>randomSleep</span><span style=color:#f92672>(</span>3000<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>);</span>
        String result <span style=color:#f92672>=</span> AsyncUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>getThreadName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> random<span style=color:#f92672>(</span>greetings<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> CompletableFuture<span style=color:#f92672>.</span><span style=color:#a6e22e>completedFuture</span><span style=color:#f92672>(</span>result<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@SafeVarargs</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>random</span><span style=color:#f92672>(</span>T<span style=color:#f92672>...</span> elements<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        LinkedList<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> greetings <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedList<span style=color:#f92672>&lt;&gt;(</span>Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>asList</span><span style=color:#f92672>(</span>elements<span style=color:#f92672>));</span>
        Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>shuffle</span><span style=color:#f92672>(</span>greetings<span style=color:#f92672>,</span> ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>());</span>
        <span style=color:#66d9ef>return</span> greetings<span style=color:#f92672>.</span><span style=color:#a6e22e>getFirst</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Here is the <code>AsyncUtil</code> class in case you are wondering what&rsquo;s going on:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AsyncUtil</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>randomSleep</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> duration<span style=color:#f92672>,</span> TimeUnit timeUnit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            timeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>duration<span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            Throwables<span style=color:#f92672>.</span><span style=color:#a6e22e>propagate</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getThreadName</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Our service will say hello in a random language within 3 seconds of time.
How do we handle the result?</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Runner</span> <span style=color:#66d9ef>implements</span> CommandLineRunner <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> AsyncService asyncService<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>String<span style=color:#f92672>...</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>

        IntStream<span style=color:#f92672>.</span><span style=color:#a6e22e>rangeClosed</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> 10<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>mapToObj</span><span style=color:#f92672>(</span>__ <span style=color:#f92672>-&gt;</span> asyncService<span style=color:#f92672>.</span><span style=color:#a6e22e>asyncGreeting</span><span style=color:#f92672>().</span><span style=color:#a6e22e>exceptionally</span><span style=color:#f92672>(</span>Throwable<span style=color:#f92672>::</span>getMessage<span style=color:#f92672>))</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>::</span>printResult<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printResult</span><span style=color:#f92672>(</span>CompletableFuture<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> future<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        future<span style=color:#f92672>.</span><span style=color:#a6e22e>thenRun</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>future<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>()));</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>My what a beauty! In the above class, we create a stream of ten elements
to call our async service ten times, make sure that we handle exceptions and
print each result on the console.</p>
<p>Please, notice that <strong>nothing is blocking</strong> in the above code.
The <code>join()</code> method will wait for a result but since we are calling it in a
callback after completion, we get a fully asynchronous code.</p>
<p>This code will produce the following output, printing each lines at different
timings:</p>
<pre tabindex=0><code>async-7 - gut de
async-5 - konnichiwa
async-4 - hallo
async-2 - hallo
async-6 - saluton
async-1 - fáilte
async-9 - päivää
async-0 - hej
async-8 - hallo
async-3 - saluton
</code></pre><h2 id=handling-timeouts>Handling timeouts<a hidden class=anchor aria-hidden=true href=#handling-timeouts>#</a></h2>
<p>An interesting question with future is how to set a timeout and cancel them
if they run late.</p>
<p>My solution is to create another executor like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TimeOutExecutorService</span> <span style=color:#66d9ef>extends</span> CompletableExecutors<span style=color:#f92672>.</span><span style=color:#a6e22e>DelegatingCompletableExecutorService</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Duration timeout<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ScheduledExecutorService schedulerExecutor<span style=color:#f92672>;</span>

    TimeOutExecutorService<span style=color:#f92672>(</span>ExecutorService delegate<span style=color:#f92672>,</span> Duration timeout<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>delegate<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> timeout<span style=color:#f92672>;</span>
        schedulerExecutor <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newScheduledThreadPool</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> CompletableFuture<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>Callable<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> task<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        CompletableFuture<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> cf <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompletableFuture<span style=color:#f92672>&lt;&gt;();</span>
        Future<span style=color:#f92672>&lt;?&gt;</span> future <span style=color:#f92672>=</span> delegate<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                cf<span style=color:#f92672>.</span><span style=color:#a6e22e>complete</span><span style=color:#f92672>(</span>task<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>());</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>CancellationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                cf<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                cf<span style=color:#f92672>.</span><span style=color:#a6e22e>completeExceptionally</span><span style=color:#f92672>(</span>ex<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>});</span>

        schedulerExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>schedule</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>cf<span style=color:#f92672>.</span><span style=color:#a6e22e>isDone</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                cf<span style=color:#f92672>.</span><span style=color:#a6e22e>completeExceptionally</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TimeoutException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Timeout after &#34;</span> <span style=color:#f92672>+</span> timeout<span style=color:#f92672>));</span>
                future<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>},</span> timeout<span style=color:#f92672>.</span><span style=color:#a6e22e>toMillis</span><span style=color:#f92672>(),</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> cf<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>This implementation was inspired by <a href=http://stackoverflow.com/questions/23575067/timeout-with-default-value-in-java-8-completablefuture/24457111#24457111>a discussion</a> on stackoverflow.</p>
<p>We can now create a new executor as a Spring bean:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;timed&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> Executor <span style=color:#a6e22e>timeoutExecutor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    ThreadFactory threadFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadFactoryBuilder<span style=color:#f92672>().</span><span style=color:#a6e22e>setNameFormat</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;timed-%d&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
    <span style=color:#66d9ef>return</span> TimedCompletables<span style=color:#f92672>.</span><span style=color:#a6e22e>timed</span><span style=color:#f92672>(</span>Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>10<span style=color:#f92672>,</span> threadFactory<span style=color:#f92672>),</span> Duration<span style=color:#f92672>.</span><span style=color:#a6e22e>ofSeconds</span><span style=color:#f92672>(</span>2<span style=color:#f92672>));</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>An use it like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Async</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;timed&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> CompletableFuture<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>asyncTimeoutGreeting</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    AsyncUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>randomSleep</span><span style=color:#f92672>(</span>3000<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>);</span>
    String result <span style=color:#f92672>=</span> AsyncUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>getThreadName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> random<span style=color:#f92672>(</span>greetings<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>return</span> CompletableFuture<span style=color:#f92672>.</span><span style=color:#a6e22e>completedFuture</span><span style=color:#f92672>(</span>result<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Now if we run the application again, about one third of the tasks will time out:</p>
<pre tabindex=0><code>timed-4 - saluton
timed-3 - hallo
timed-7 - saluton
timed-8 - fáilte
timed-1 - saluton
timed-5 - hallo
Timeout after PT2S
Timeout after PT2S
Timeout after PT2S
Timeout after PT2S
</code></pre><h2 id=profiling-threads-with-aop>Profiling threads with AOP<a hidden class=anchor aria-hidden=true href=#profiling-threads-with-aop>#</a></h2>
<p>Let&rsquo;s add a dependency to <code>spring-boot-starter-aop</code> to automatically profile the
execution of our async methods:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Aspect</span>
<span style=color:#a6e22e>@Component</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceProfiler</span> <span style=color:#f92672>{</span>

   <span style=color:#a6e22e>@Pointcut</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;execution(java.util.concurrent.CompletableFuture completable.service.*.*(..))&#34;</span><span style=color:#f92672>)</span>
   <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>serviceMethods</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
   <span style=color:#f92672>}</span>

   <span style=color:#a6e22e>@Around</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;serviceMethods()&#34;</span><span style=color:#f92672>)</span>
   <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>profile</span><span style=color:#f92672>(</span>ProceedingJoinPoint pjp<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
       StopWatch stopWatch <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StopWatch<span style=color:#f92672>();</span>
       stopWatch<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
       Object output <span style=color:#f92672>=</span> pjp<span style=color:#f92672>.</span><span style=color:#a6e22e>proceed</span><span style=color:#f92672>();</span>
       stopWatch<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
       <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>output <span style=color:#66d9ef>instanceof</span> CompletableFuture<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
           CompletableFuture future <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>CompletableFuture<span style=color:#f92672>)</span> output<span style=color:#f92672>;</span>
           String debug <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;(%d ms)&#34;</span><span style=color:#f92672>,</span> stopWatch<span style=color:#f92672>.</span><span style=color:#a6e22e>getTotalTimeMillis</span><span style=color:#f92672>());</span>
           future<span style=color:#f92672>.</span><span style=color:#a6e22e>thenAccept</span><span style=color:#f92672>(</span>o <span style=color:#f92672>-&gt;</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>o <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> debug<span style=color:#f92672>));</span>
       <span style=color:#f92672>}</span>
       <span style=color:#66d9ef>return</span> output<span style=color:#f92672>;</span>
   <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>This is a bit unnecessary but I used one of the callbacks of <code>CompletableFuture</code>
to display the profiling message :)</p>
<h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>Java 8 <code>CompletableFuture</code>s provide an awesome API to deal with async
tasks. Too bad that no Executor is able to create them without a bit of code
on our part.</p>
<p>I&rsquo;m not a concurrency expert so please tell me what you think of this solution
in the comments.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://geowarin.com/tags/spring/>spring</a></li>
<li><a href=https://geowarin.com/tags/futures/>futures</a></li>
<li><a href=https://geowarin.com/tags/async/>async</a></li>
<li><a href=https://geowarin.com/tags/featured/>featured</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://geowarin.com/spring-boot-and-react-hot-loader/>
<span class=title>« Prev Page</span>
<br>
<span>Spring Boot and React hot loader</span>
</a>
<a class=next href=https://geowarin.com/the-missing-fish-shell-tutorial/>
<span class=title>Next Page »</span>
<br>
<span>The missing fish shell tutorial</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on twitter" href="https://twitter.com/intent/tweet/?text=Completable%20futures%20with%20Spring%20async&url=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f&hashtags=spring%2cfutures%2casync%2cfeatured"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f&title=Completable%20futures%20with%20Spring%20async&summary=Completable%20futures%20with%20Spring%20async&source=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f&title=Completable%20futures%20with%20Spring%20async"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on whatsapp" href="https://api.whatsapp.com/send?text=Completable%20futures%20with%20Spring%20async%20-%20https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Completable futures with Spring async on telegram" href="https://telegram.me/share/url?text=Completable%20futures%20with%20Spring%20async&url=https%3a%2f%2fgeowarin.com%2fcompletable-futures-with-spring-async%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><script src=https://utteranc.es/client.js repo=geowarin/geowarin.github.io issue-term=title theme=photon-dark crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://geowarin.com>Geowarin</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>