<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>A simple chat with Spring Boot and RethinkDB | Geowarin</title>
<meta name=keywords content="chat">
<meta name=description content="RethinkDB is a great database engine allowing you to receive live updates on your data. Let&rsquo;s create a Spring Boot App and give it a try!">
<meta name=author content>
<link rel=canonical href=https://geowarin.github.io/a-simple-chat-with-spring-boot-and-rethinkdb/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.6f60056d44d3f7eb69a4bc6c332b59960f3a995802bded244750232f33713c49.css integrity="sha256-b2AFbUTT9+tppLxsMytZlg86mVgCve0kR1AjLzNxPEk=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://geowarin.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://geowarin.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://geowarin.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://geowarin.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://geowarin.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-46024908-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="A simple chat with Spring Boot and RethinkDB">
<meta property="og:description" content="RethinkDB is a great database engine allowing you to receive live updates on your data. Let&rsquo;s create a Spring Boot App and give it a try!">
<meta property="og:type" content="article">
<meta property="og:url" content="https://geowarin.github.io/a-simple-chat-with-spring-boot-and-rethinkdb/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2016-01-28T00:00:00+00:00">
<meta property="article:modified_time" content="2016-01-28T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="A simple chat with Spring Boot and RethinkDB">
<meta name=twitter:description content="RethinkDB is a great database engine allowing you to receive live updates on your data. Let&rsquo;s create a Spring Boot App and give it a try!">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://geowarin.github.io/post/"},{"@type":"ListItem","position":3,"name":"A simple chat with Spring Boot and RethinkDB","item":"https://geowarin.github.io/a-simple-chat-with-spring-boot-and-rethinkdb/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A simple chat with Spring Boot and RethinkDB","name":"A simple chat with Spring Boot and RethinkDB","description":"RethinkDB is a great database engine allowing you to receive live updates on your data. Let\u0026rsquo;s create a Spring Boot App and give it a try!","keywords":["chat"],"articleBody":"The Java driver for RethinkDB has recently been released in beta.\nI created a little chat application with Spring Boot, you can see the result on github.\nThere is a docker-compose file at the root of the project that you can use to run a RethinkDB instance instead of installing it directly on your machine.\nWhy RethinkDB? I already gave RethinkDB a try a few months ago and I was very impressed with its beautiful admin GUI, its clustering capabilities and its clever and intuitive API.\nBut there is more! RethinkDB is a DB engine designed to push updates to the clients in real time.\nIn the CAP theorem, rethinkDB focuses on being Consistent in case of difficulties in the cluster.\nRelevant quote from the FAQ:\nOnce RethinkDB is started, you can connect on the beautiful admin GUI on port 8080:\nSetting up the project I created a Gradle project with the web and websocket Spring boot starters. I also added a couple of webjars: jquery for ajax requests, sockjs and stomp to connect to Spring’s websockets:\ndependencies { compile('org.springframework.boot:spring-boot-starter-web') compile('org.springframework.boot:spring-boot-starter-websocket') compile('org.springframework.boot:spring-boot-devtools') compile 'org.webjars:jquery:3.0.0-alpha1' compile 'org.webjars:sockjs-client:1.0.0' compile 'org.webjars:stomp-websocket:2.3.3' compile 'com.rethinkdb:rethinkdb-driver:2.2-b1-SNAPSHOT' } Getting a connection Every action we will perform on the database will require a Connection. We can create a small factory that we will later use in the code:\npublic class RethinkDBConnectionFactory { private String host; public RethinkDBConnectionFactory(String host) { this.host = host; } public ConnectionConnectionInstance createConnection() { try { return RethinkDB.r.connection().hostname(host).connect(); } catch (TimeoutException e) { throw new RuntimeException(e); } } } Initializing the DB For this little chat, we will need a database called chat and a table called messages.\nTo avoid creating them by hand, we can create a Spring bean that will get called when the application starts:\npublic class DbInitializer implements InitializingBean { @Autowired private RethinkDBConnectionFactory connectionFactory; @Autowired private ChatChangesListener chatChangesListener; private static final RethinkDB r = RethinkDB.r; @Override public void afterPropertiesSet() throws Exception { createDb(); // we will see that later on  chatChangesListener.pushChangesToWebSocket(); } private void createDb() { ConnectionConnectionInstance connection = connectionFactory.createConnection(); ListString dbList = r.dbList().run(connection); if (!dbList.contains(\"chat\")) { r.dbCreate(\"chat\").run(connection); } ListString tables = r.db(\"chat\").tableList().run(connection); if (!tables.contains(\"messages\")) { r.db(\"chat\").tableCreate(\"messages\").run(connection); r.db(\"chat\").table(\"messages\").indexCreate(\"time\").run(connection); } } } Ignore the pushChangesToWebSocket() method call for now, we will see this in a minute.\nWe can already get a feel for the RethinkDB API. It was originally designed for dynamically typed language so some things might be a little awkward for hardcore Java developers.\nFor instance, the result of the operations can be of any type. RethinkDB will try to coerce the result according to the return type chosen, if possible.\nThis is both good, because of the additional flexibility, and bad, because you cannot rely on autocomplete to know the return type of an operation.\nThe ChatController The chat controller will react to two things:\n GETting the last 20 messages from the DB POSTing a new message  Here is the code, which is kind of straight-forward:\n@RestController @RequestMapping(\"/chat\") public class ChatController { protected final Logger log = LoggerFactory.getLogger(ChatController.class); private static final RethinkDB r = RethinkDB.r; @Autowired private RethinkDBConnectionFactory connectionFactory; @RequestMapping(method = RequestMethod.POST) public ChatMessage postMessage(@RequestBody ChatMessage chatMessage) { chatMessage.setTime(OffsetDateTime.now()); Object run = r.db(\"chat\").table(\"messages\").insert(chatMessage) .run(connectionFactory.createConnection()); log.info(\"Insert {}\", run); return chatMessage; } @RequestMapping(method = RequestMethod.GET) public ListChatMessage getMessages() { ListChatMessage messages = r.db(\"chat\").table(\"messages\") .orderBy().optArg(\"index\", r.desc(\"time\")) .limit(20) .orderBy(\"time\") .run(connectionFactory.createConnection(), ChatMessage.class); return messages; } } The cool thing is that the API clean and simple to understand.\nSome things are still a bit funny:\n The optArg after the orderBy is a bit cryptic I spent some time figuring out that your POJO class must not contain any id attribute for the auto-generation to work  Setting up websockets Now that we can read and write from the DB, we need to push the updates to the client in real time.\nWe will use websockets over SockJS for that. The configuration for websockets is pretty classic:\n@Configuration @EnableWebSocketMessageBroker public class WebSocketConfig extends AbstractWebSocketMessageBrokerConfigurer { @Override public void configureMessageBroker(MessageBrokerRegistry config) { config.enableSimpleBroker(\"/topic\"); } @Override public void registerStompEndpoints(StompEndpointRegistry registry) { registry.addEndpoint(\"/chatWS\").withSockJS(); } } How to read that:\n Our clients will be able to connect to the /chatWS endpoint The clients will then have the possibility to listen to any topic whose url begins with /topic (i.e, /topic/messages) and get notified in real time  Listening to the updates We will now listen to database updates in a thread and broadcast the changes to all the clients listening on the web socket.\nWe use the @Async annotation, so Spring will take care of running the code in a thread for us:\n@Service public class ChatChangesListener { protected final Logger log = LoggerFactory.getLogger(ChatChangesListener.class); private static final RethinkDB r = RethinkDB.r; @Autowired private RethinkDBConnectionFactory connectionFactory; @Autowired private SimpMessagingTemplate webSocket; @Async public void pushChangesToWebSocket() { CursorChatMessage cursor = r.db(\"chat\").table(\"messages\").changes() .getField(\"new_val\") .run(connectionFactory.createConnection(), ChatMessage.class); while (cursor.hasNext()) { ChatMessage chatMessage = cursor.next(); log.info(\"New message: {}\", chatMessage.message); webSocket.convertAndSend(\"/topic/messages\", chatMessage); } } } So what happens here? Each time a change happens in the database, we will get an update. This update will contain two fields: old_val and new_val. See the documentation.\nSince we are only interested in the new things, we will only retrieve the new_val field.\nNote that the second (optional) argument to the run method is a class. If present, RethinkDB will try to convert the data to this target class, just like we did in the ChatController above.\nThen, we simply broadcast the message to all the clients listening on /topic/messages.\nThe client If you never used webjars before, they are simply jar packages containing frontend dependencies. With Spring Boot we can use them in our web pages directly. Below the index.html file of our application:\n html lang=\"en\" head meta charset=\"UTF-8\" titleTitletitle script src=\"webjars/jquery/3.0.0-alpha1/jquery.js\"script script src=\"webjars/sockjs-client/1.0.0/sockjs.js\"script script src=\"webjars/stomp-websocket/2.3.3/stomp.js\"script script src=\"js/main.js\"script head body div id=\"chat\" div id=\"messages\" div form onsubmit=\"sendMessage(); return false;\" label Message: input type=\"text\" id=\"messageInput\" / label button type=\"submit\"Sendbutton form div body html And the javascript:\nvar userName = window.prompt(\"Enter your name\", \"some user\"); function appendMessage(message) { $('#messages').append($('').text(message.from + \": \" + message.message)) } function getPreviousMessages() { $.get('/chat').done(messages = messages.forEach(appendMessage)); } function sendMessage() { var $messageInput = $('#messageInput'); var message = {message: $messageInput.val(), from: userName}; $messageInput.val(''); post('/chat', message); } function onNewMessage(result) { var message = JSON.parse(result.body); appendMessage(message); } function connectWebSocket() { var socket = new SockJS('/chatWS'); stompClient = Stomp.over(socket); //stompClient.debug = null;  stompClient.connect({}, (frame) = { console.log('Connected: ' + frame); stompClient.subscribe('/topic/messages', onNewMessage); }); } getPreviousMessages(); connectWebSocket(); Conclusion RethinkDB is an awesome database, especially because it lets you decouple the code that updates the database and the code that listens to the changes.\nThe driver is brand new and still in beta but we can already salute the efforts of the developers for such an amazing work!\nAs always, check out the project on github and tell me what you think!\n","wordCount":"1121","inLanguage":"en","datePublished":"2016-01-28T00:00:00Z","dateModified":"2016-01-28T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://geowarin.github.io/a-simple-chat-with-spring-boot-and-rethinkdb/"},"publisher":{"@type":"Organization","name":"Geowarin","logo":{"@type":"ImageObject","url":"https://geowarin.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://geowarin.github.io accesskey=h title="Geowarin (Alt + H)">Geowarin</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://geowarin.github.io/archive/ title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://geowarin.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://geowarin.github.io/mastering-spring-mvc-4/ title=Book>
<span>Book</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://geowarin.github.io>Home</a>&nbsp;»&nbsp;<a href=https://geowarin.github.io/post/>Posts</a></div>
<h1 class=post-title>
A simple chat with Spring Boot and RethinkDB
</h1>
<div class=post-meta><span title="2016-01-28 00:00:00 +0000 UTC">January 28, 2016</span>&nbsp;·&nbsp;6 min
</div>
</header>
<div class=post-content><p>The Java driver for <a href=https://www.rethinkdb.com/>RethinkDB</a> has recently
<a href=https://rethinkdb.com/blog/official-java-driver/>been released</a> in beta.</p>
<p>I created a little chat application with Spring Boot, you can see the result
<a href=https://github.com/geowarin/boot-rethinkdb>on github</a>.</p>
<p>There is a docker-compose file at the root of the project that you can
use to run a RethinkDB instance instead of installing it directly on your machine.</p>
<h2 id=why-rethinkdb>Why RethinkDB?<a hidden class=anchor aria-hidden=true href=#why-rethinkdb>#</a></h2>
<p>I already gave RethinkDB a try a few months ago and I was very impressed
with its beautiful admin GUI, its clustering capabilities and its clever
and intuitive API.</p>
<p>But there is more! RethinkDB is a DB engine designed to push updates to the clients
in real time.</p>
<p>In the <a href=https://github.com/henryr/cap-faq>CAP theorem</a>, rethinkDB focuses on being
Consistent in case of difficulties in the cluster.</p>
<p>Relevant quote from the <a href=https://www.rethinkdb.com/docs/architecture/#cap-theorem>FAQ</a>:</p>
<p>Once RethinkDB is started, you can connect on the beautiful admin GUI on port <code>8080</code>:</p>
<p><img loading=lazy src=/assets/images/articles/2016-01-rethinkDB-admin.png alt="The awesome GUI" title="The RethinkDB admin GUI">
</p>
<h2 id=setting-up-the-project>Setting up the project<a hidden class=anchor aria-hidden=true href=#setting-up-the-project>#</a></h2>
<p>I created a Gradle project with the <code>web</code> and <code>websocket</code> Spring boot starters.
I also added a couple of <a href=https://spring.io/blog/2014/01/03/utilizing-webjars-in-spring-boot>webjars</a>:
<code>jquery</code> for ajax requests, sockjs and stomp to connect to Spring&rsquo;s websockets:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy>dependencies <span style=color:#f92672>{</span>
    compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span><span style=color:#f92672>)</span>
    compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-websocket&#39;</span><span style=color:#f92672>)</span>
    compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-devtools&#39;</span><span style=color:#f92672>)</span>

    compile <span style=color:#e6db74>&#39;org.webjars:jquery:3.0.0-alpha1&#39;</span>
    compile <span style=color:#e6db74>&#39;org.webjars:sockjs-client:1.0.0&#39;</span>
    compile <span style=color:#e6db74>&#39;org.webjars:stomp-websocket:2.3.3&#39;</span>

    compile <span style=color:#e6db74>&#39;com.rethinkdb:rethinkdb-driver:2.2-b1-SNAPSHOT&#39;</span>
<span style=color:#f92672>}</span>
</code></pre></div><h2 id=getting-a-connection>Getting a connection<a hidden class=anchor aria-hidden=true href=#getting-a-connection>#</a></h2>
<p>Every action we will perform on the database will require a <code>Connection</code>.
We can create a small factory that we will later use in the code:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RethinkDBConnectionFactory</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> String host<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RethinkDBConnectionFactory</span><span style=color:#f92672>(</span>String host<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>host</span> <span style=color:#f92672>=</span> host<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> Connection<span style=color:#f92672>&lt;</span>ConnectionInstance<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createConnection</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>return</span> RethinkDB<span style=color:#f92672>.</span><span style=color:#a6e22e>r</span><span style=color:#f92672>.</span><span style=color:#a6e22e>connection</span><span style=color:#f92672>().</span><span style=color:#a6e22e>hostname</span><span style=color:#f92672>(</span>host<span style=color:#f92672>).</span><span style=color:#a6e22e>connect</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>TimeoutException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h2 id=initializing-the-db>Initializing the DB<a hidden class=anchor aria-hidden=true href=#initializing-the-db>#</a></h2>
<p>For this little chat, we will need a database called <code>chat</code> and a table
called <code>messages</code>.</p>
<p>To avoid creating them by hand, we can create a Spring bean that will get called
when the application starts:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DbInitializer</span> <span style=color:#66d9ef>implements</span> InitializingBean <span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> RethinkDBConnectionFactory connectionFactory<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> ChatChangesListener chatChangesListener<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> RethinkDB r <span style=color:#f92672>=</span> RethinkDB<span style=color:#f92672>.</span><span style=color:#a6e22e>r</span><span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afterPropertiesSet</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        createDb<span style=color:#f92672>();</span>
        <span style=color:#75715e>// we will see that later on
</span><span style=color:#75715e></span>        chatChangesListener<span style=color:#f92672>.</span><span style=color:#a6e22e>pushChangesToWebSocket</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createDb</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        Connection<span style=color:#f92672>&lt;</span>ConnectionInstance<span style=color:#f92672>&gt;</span> connection <span style=color:#f92672>=</span> connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>createConnection</span><span style=color:#f92672>();</span>
        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> dbList <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>dbList</span><span style=color:#f92672>().</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>connection<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>dbList<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chat&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            r<span style=color:#f92672>.</span><span style=color:#a6e22e>dbCreate</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chat&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>connection<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> tables <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>db</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chat&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>tableList</span><span style=color:#f92672>().</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>connection<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>tables<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;messages&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            r<span style=color:#f92672>.</span><span style=color:#a6e22e>db</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chat&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>tableCreate</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;messages&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>connection<span style=color:#f92672>);</span>
            r<span style=color:#f92672>.</span><span style=color:#a6e22e>db</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chat&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>table</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;messages&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>indexCreate</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;time&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>connection<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Ignore the <code>pushChangesToWebSocket()</code> method call for now, we will see this in a minute.</p>
<p>We can already get a feel for the RethinkDB API.
It was originally designed for dynamically typed language so some things might
be a little awkward for hardcore Java developers.</p>
<p>For instance, the result of the operations can be of any type.
RethinkDB will try to coerce the result according to the return type chosen, if possible.</p>
<p>This is both good, because of the additional flexibility, and bad, because you
cannot rely on autocomplete to know the return type of an operation.</p>
<h2 id=the-chatcontroller>The ChatController<a hidden class=anchor aria-hidden=true href=#the-chatcontroller>#</a></h2>
<p>The chat controller will react to two things:</p>
<ol>
<li><code>GET</code>ting the last 20 messages from the DB</li>
<li><code>POST</code>ing a new message</li>
</ol>
<p>Here is the code, which is kind of straight-forward:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@RestController</span>
<span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/chat&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ChatController</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>ChatController<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> RethinkDB r <span style=color:#f92672>=</span> RethinkDB<span style=color:#f92672>.</span><span style=color:#a6e22e>r</span><span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> RethinkDBConnectionFactory connectionFactory<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>POST</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> ChatMessage <span style=color:#a6e22e>postMessage</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> ChatMessage chatMessage<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        chatMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>setTime</span><span style=color:#f92672>(</span>OffsetDateTime<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>());</span>
        Object run <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>db</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chat&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>table</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;messages&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>insert</span><span style=color:#f92672>(</span>chatMessage<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>createConnection</span><span style=color:#f92672>());</span>

        log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Insert {}&#34;</span><span style=color:#f92672>,</span> run<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> chatMessage<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>ChatMessage<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getMessages</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>

        List<span style=color:#f92672>&lt;</span>ChatMessage<span style=color:#f92672>&gt;</span> messages <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>db</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chat&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>table</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;messages&#34;</span><span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>orderBy</span><span style=color:#f92672>().</span><span style=color:#a6e22e>optArg</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;index&#34;</span><span style=color:#f92672>,</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>desc</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;time&#34;</span><span style=color:#f92672>))</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>limit</span><span style=color:#f92672>(</span>20<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>orderBy</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;time&#34;</span><span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>createConnection</span><span style=color:#f92672>(),</span> ChatMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>

        <span style=color:#66d9ef>return</span> messages<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>The cool thing is that the API clean and simple to understand.</p>
<p>Some things are still a bit funny:</p>
<ul>
<li>The <code>optArg</code> after the orderBy is a bit cryptic</li>
<li>I spent some time figuring out that your POJO class must not contain any id
attribute for the auto-generation to work</li>
</ul>
<h2 id=setting-up-websockets>Setting up websockets<a hidden class=anchor aria-hidden=true href=#setting-up-websockets>#</a></h2>
<p>Now that we can read and write from the DB, we need to push the updates to
the client in real time.</p>
<p>We will use websockets over <a href=http://www.rabbitmq.com/blog/2011/09/13/sockjs-websocket-emulation/>SockJS</a> for that.
The configuration for websockets is pretty classic:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@EnableWebSocketMessageBroker</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WebSocketConfig</span> <span style=color:#66d9ef>extends</span> AbstractWebSocketMessageBrokerConfigurer <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configureMessageBroker</span><span style=color:#f92672>(</span>MessageBrokerRegistry config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        config<span style=color:#f92672>.</span><span style=color:#a6e22e>enableSimpleBroker</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/topic&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerStompEndpoints</span><span style=color:#f92672>(</span>StompEndpointRegistry registry<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        registry<span style=color:#f92672>.</span><span style=color:#a6e22e>addEndpoint</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/chatWS&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withSockJS</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>How to read that:</p>
<ul>
<li>Our clients will be able to connect to the <code>/chatWS</code> endpoint</li>
<li>The clients will then have the possibility to listen to any topic whose url begins
with <code>/topic</code> (i.e, <code>/topic/messages</code>) and get notified in real time</li>
</ul>
<h2 id=listening-to-the-updates>Listening to the updates<a hidden class=anchor aria-hidden=true href=#listening-to-the-updates>#</a></h2>
<p>We will now listen to database updates in a thread and broadcast the changes
to all the clients listening on the web socket.</p>
<p>We use the <code>@Async</code> annotation, so Spring will take care of running the code in a thread
for us:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Service</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ChatChangesListener</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>ChatChangesListener<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> RethinkDB r <span style=color:#f92672>=</span> RethinkDB<span style=color:#f92672>.</span><span style=color:#a6e22e>r</span><span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> RethinkDBConnectionFactory connectionFactory<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> SimpMessagingTemplate webSocket<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Async</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pushChangesToWebSocket</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
      Cursor<span style=color:#f92672>&lt;</span>ChatMessage<span style=color:#f92672>&gt;</span> cursor <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>db</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chat&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>table</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;messages&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>changes</span><span style=color:#f92672>()</span>
              <span style=color:#f92672>.</span><span style=color:#a6e22e>getField</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;new_val&#34;</span><span style=color:#f92672>)</span>
              <span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>createConnection</span><span style=color:#f92672>(),</span> ChatMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>

      <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
          ChatMessage chatMessage <span style=color:#f92672>=</span> cursor<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
          log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;New message: {}&#34;</span><span style=color:#f92672>,</span> chatMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>message</span><span style=color:#f92672>);</span>
          webSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>convertAndSend</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/topic/messages&#34;</span><span style=color:#f92672>,</span> chatMessage<span style=color:#f92672>);</span>
      <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>So what happens here? Each time a change happens in the database,
we will get an update. This update will contain two fields: <code>old_val</code> and <code>new_val</code>.
See <a href=https://www.rethinkdb.com/api/java/changes/>the documentation</a>.</p>
<p>Since we are only interested in the new things, we will only retrieve the <code>new_val</code> field.</p>
<p>Note that the second (optional) argument to the <code>run</code> method is a class.
If present, RethinkDB will try to convert the data to this target class, just like
we did in the <code>ChatController</code> above.</p>
<p>Then, we simply broadcast the message to all the clients listening on <code>/topic/messages</code>.</p>
<h2 id=the-client>The client<a hidden class=anchor aria-hidden=true href=#the-client>#</a></h2>
<p>If you never used webjars before, they are simply jar packages containing frontend
dependencies. With Spring Boot we can use them in our web pages directly.
Below the <code>index.html</code> file of our application:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
&lt;<span style=color:#f92672>head</span>&gt;
    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>&gt;
    &lt;<span style=color:#f92672>title</span>&gt;Title&lt;/<span style=color:#f92672>title</span>&gt;

    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;webjars/jquery/3.0.0-alpha1/jquery.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;webjars/sockjs-client/1.0.0/sockjs.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;webjars/stomp-websocket/2.3.3/stomp.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;js/main.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
&lt;/<span style=color:#f92672>head</span>&gt;
&lt;<span style=color:#f92672>body</span>&gt;

&lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;chat&#34;</span>&gt;

    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;messages&#34;</span>&gt;

    &lt;/<span style=color:#f92672>div</span>&gt;
    &lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>onsubmit</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sendMessage(); return false;&#34;</span>&gt;
        &lt;<span style=color:#f92672>label</span>&gt;
            Message:
            &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;messageInput&#34;</span> /&gt;
        &lt;/<span style=color:#f92672>label</span>&gt;
        &lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span>&gt;Send&lt;/<span style=color:#f92672>button</span>&gt;
    &lt;/<span style=color:#f92672>form</span>&gt;
&lt;/<span style=color:#f92672>div</span>&gt;

&lt;/<span style=color:#f92672>body</span>&gt;
&lt;/<span style=color:#f92672>html</span>&gt;
</code></pre></div><p>And the javascript:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>userName</span> <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>prompt</span>(<span style=color:#e6db74>&#34;Enter your name&#34;</span>, <span style=color:#e6db74>&#34;some user&#34;</span>);

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>appendMessage</span>(<span style=color:#a6e22e>message</span>) {
    <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#messages&#39;</span>).<span style=color:#a6e22e>append</span>(<span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;&lt;div /&gt;&#39;</span>).<span style=color:#a6e22e>text</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>from</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message</span>))
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getPreviousMessages</span>() {
    <span style=color:#a6e22e>$</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/chat&#39;</span>).<span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>messages</span> =&gt; <span style=color:#a6e22e>messages</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>appendMessage</span>));
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendMessage</span>() {
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>$messageInput</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#messageInput&#39;</span>);
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> {<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>$messageInput</span>.<span style=color:#a6e22e>val</span>(), <span style=color:#a6e22e>from</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>userName</span>};
    <span style=color:#a6e22e>$messageInput</span>.<span style=color:#a6e22e>val</span>(<span style=color:#e6db74>&#39;&#39;</span>);
    <span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/chat&#39;</span>, <span style=color:#a6e22e>message</span>);
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>onNewMessage</span>(<span style=color:#a6e22e>result</span>) {
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>body</span>);
    <span style=color:#a6e22e>appendMessage</span>(<span style=color:#a6e22e>message</span>);
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>connectWebSocket</span>() {
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>socket</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SockJS</span>(<span style=color:#e6db74>&#39;/chatWS&#39;</span>);
    <span style=color:#a6e22e>stompClient</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Stomp</span>.<span style=color:#a6e22e>over</span>(<span style=color:#a6e22e>socket</span>);
    <span style=color:#75715e>//stompClient.debug = null;
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>stompClient</span>.<span style=color:#a6e22e>connect</span>({}, (<span style=color:#a6e22e>frame</span>) =&gt; {
        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Connected: &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>frame</span>);
        <span style=color:#a6e22e>stompClient</span>.<span style=color:#a6e22e>subscribe</span>(<span style=color:#e6db74>&#39;/topic/messages&#39;</span>, <span style=color:#a6e22e>onNewMessage</span>);
    });
}

<span style=color:#a6e22e>getPreviousMessages</span>();
<span style=color:#a6e22e>connectWebSocket</span>();
</code></pre></div><p><img loading=lazy src=/assets/images/articles/2016-01-rethinkDB-hello.gif alt="The chat with a bit of CSS" title="Hello world!">
</p>
<h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>RethinkDB is an awesome database, especially because it lets you decouple the
code that updates the database and the code that listens to the changes.</p>
<p>The driver is brand new and still in beta but we can already salute the efforts
of the developers for such an amazing work!</p>
<p>As always, check out the project <a href=https://github.com/geowarin/boot-rethinkdb>on github</a>
and tell me what you think!</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://geowarin.github.io/tags/chat/>chat</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://geowarin.github.io/correctly-handle-jsr-310-java-8-dates-with-jackson/>
<span class=title>« Prev Page</span>
<br>
<span>Correctly handle JSR-310 (java 8) dates with Jackson</span>
</a>
<a class=next href=https://geowarin.github.io/test-your-java-application-with-groovy/>
<span class=title>Next Page »</span>
<br>
<span>Test your Java application with Groovy</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share A simple chat with Spring Boot and RethinkDB on twitter" href="https://twitter.com/intent/tweet/?text=A%20simple%20chat%20with%20Spring%20Boot%20and%20RethinkDB&url=https%3a%2f%2fgeowarin.github.io%2fa-simple-chat-with-spring-boot-and-rethinkdb%2f&hashtags=chat"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share A simple chat with Spring Boot and RethinkDB on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fgeowarin.github.io%2fa-simple-chat-with-spring-boot-and-rethinkdb%2f&title=A%20simple%20chat%20with%20Spring%20Boot%20and%20RethinkDB&summary=A%20simple%20chat%20with%20Spring%20Boot%20and%20RethinkDB&source=https%3a%2f%2fgeowarin.github.io%2fa-simple-chat-with-spring-boot-and-rethinkdb%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share A simple chat with Spring Boot and RethinkDB on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgeowarin.github.io%2fa-simple-chat-with-spring-boot-and-rethinkdb%2f&title=A%20simple%20chat%20with%20Spring%20Boot%20and%20RethinkDB"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share A simple chat with Spring Boot and RethinkDB on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgeowarin.github.io%2fa-simple-chat-with-spring-boot-and-rethinkdb%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share A simple chat with Spring Boot and RethinkDB on whatsapp" href="https://api.whatsapp.com/send?text=A%20simple%20chat%20with%20Spring%20Boot%20and%20RethinkDB%20-%20https%3a%2f%2fgeowarin.github.io%2fa-simple-chat-with-spring-boot-and-rethinkdb%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share A simple chat with Spring Boot and RethinkDB on telegram" href="https://telegram.me/share/url?text=A%20simple%20chat%20with%20Spring%20Boot%20and%20RethinkDB&url=https%3a%2f%2fgeowarin.github.io%2fa-simple-chat-with-spring-boot-and-rethinkdb%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//geowarin.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://geowarin.github.io>Geowarin</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>